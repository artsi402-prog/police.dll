using Life;
using Life.Network;
using Life.UI;
using UnityEngine;
using System.Collections.Generic;

namespace PoliceAmboise
{
    public class PoliceAmboiseModKit : Plugin
    {
        // ===== DONNÃ‰ES =====
        private Dictionary<int, string> grades = new Dictionary<int, string>();
        private Dictionary<int, List<string>> casiers = new Dictionary<int, List<string>>();
        private Dictionary<int, float> panicCooldown = new Dictionary<int, float>();
        private const float PANIC_CD = 30f;

        private Vector3 commissariatPos = new Vector3(123f, 0f, 456f);
        private float commissariatRadius = 5f;

        public PoliceAmboiseModKit(IGameAPI api) : base(api) { }

        public override void OnPluginInit()
        {
            base.OnPluginInit();
            Debug.Log("[Police Amboise] ModKit prÃªt ðŸš“");
        }

        public override void OnPlayerInput(Player player, KeyCode key, bool onUI)
        {
            if (onUI) return;

            if (key == KeyCode.F11 && IsPolice(player))
                OpenMenu(player);

            if (key == KeyCode.F10 && IsPolice(player))
                Panic(player);
        }

        public override void OnPlayerTick(Player player)
        {
            if (Vector3.Distance(player.transform.position, commissariatPos) < commissariatRadius)
            {
                player.SendText("ðŸ“ Commissariat - F11 pour menu police");
            }
        }

        // ================= MENUS =================
        private void OpenMenu(Player player)
        {
            UIPanel panel = new UIPanel("PoliceMenu", UIPanel.PanelType.Text);

            // Titre Belgique + Nom du joueur + Grade
            panel.SetTitle(
                "<color=#000000>ðŸš“ POLICE</color> " +
                "<color=#FFD700>AMBOISE</color>\n" +
                "<color=#FF0000>" + player.FullName + " | " + GetGrade(player) + "</color>"
            );

            panel.Text =
                "<color=#FFD700>Menu Police</color>\n\n" +
                "Grade : <color=#FFFFFF>" + GetGrade(player) + "</color>";

            panel.AddButton("ðŸ“» Radio police", ui => RadioMenu(player));
            panel.AddButton("ðŸ“œ Casier judiciaire", ui => CasierMenu(player));
            panel.AddButton("ðŸ‘® Service", ui => Service(player));
            panel.AddButton("âŒ Fermer", ui => player.ClosePanel(ui));

            player.ShowPanelUI(panel);
        }

        private void RadioMenu(Player player)
        {
            UIPanel panel = new UIPanel("Radio", UIPanel.PanelType.Text);
            panel.SetTitle("ðŸ“» Radio Police");

            panel.Text = "Messages internes police";

            panel.AddButton("ðŸš¨ Intervention urgente", ui =>
            {
                BroadcastPolice("ðŸš¨ Intervention urgente demandÃ©e !");
            });

            panel.AddButton("ðŸ“ ContrÃ´le en cours", ui =>
            {
                BroadcastPolice("ðŸ“ ContrÃ´le en cours par " + player.FullName);
            });

            panel.AddButton("â¬… Retour", ui => OpenMenu(player));

            player.ShowPanelUI(panel);
        }

        private void CasierMenu(Player player)
        {
            Player target = player.GetClosestPlayer();
            if (target == null)
            {
                player.Notify("Police", "Aucun citoyen proche");
                return;
            }

            if (!casiers.ContainsKey(target.Id))
                casiers[target.Id] = new List<string>();

            UIPanel panel = new UIPanel("Casier", UIPanel.PanelType.Text);
            panel.SetTitle("ðŸ“œ Casier judiciaire");

            panel.Text = $"Citoyen : {target.FullName}\n\nInfractions :\n";
            foreach (string s in casiers[target.Id])
                panel.Text += "- " + s + "\n";

            panel.AddButton("âž• Ajouter infraction", ui =>
            {
                casiers[target.Id].Add("Infraction RP");
                player.Notify("Police", "Infraction ajoutÃ©e");
            });

            panel.AddButton("â¬… Retour", ui => OpenMenu(player));
            player.ShowPanelUI(panel);
        }

        // ================= LOGIQUE =================
        private void Service(Player player)
        {
            player.SetAdminService(true);
            player.Notify("Police", "Vous Ãªtes en service ðŸ‘®");
        }

        private void Panic(Player player)
        {
            if (panicCooldown.ContainsKey(player.Id) &&
                Time.time - panicCooldown[player.Id] < PANIC_CD)
            {
                player.Notify("PANIC", "Cooldown actif â±ï¸");
                return;
            }

            panicCooldown[player.Id] = Time.time;

            BroadcastPolice(
                $"ðŸš¨ PANIC dÃ©clenchÃ© par {player.FullName}\nðŸ“ Position connue"
            );

            player.PlaySound("panic");
        }

        private void BroadcastPolice(string msg)
        {
            foreach (Player p in LifeServer.Instance.Players)
            {
                if (IsPolice(p))
                {
                    p.Notify("ðŸ“» Radio Police", msg);
                    p.PlaySound("radio");
                }
            }
        }

        // ================= GRADES =================
        private string GetGrade(Player player)
        {
            if (!grades.ContainsKey(player.Id))
                grades[player.Id] = "Agent";

            return grades[player.Id];
        }

        // ================= UTILS =================
        private bool IsPolice(Player p)
        {
            return p.Job != null && p.Job.Name == "Police";
        }
    }
}
